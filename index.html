<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TOTP Web ‚Äî Client-side</title>
<link rel="stylesheet" href="style.css">
<style>
/* --- Chat / Owner Styles --- */
#ownerBtn { position: fixed; bottom: 10px; right: 10px; }
#ownerPanel { position: fixed; bottom: 50px; right: 10px; width: 320px; max-height: 400px; background:#fff; border:1px solid #ccc; border-radius:8px; display:none; box-shadow:0 2px 10px rgba(0,0,0,0.2); }
.chat-header { display:flex; justify-content:space-between; padding:8px; background:#eee; border-bottom:1px solid #ccc; font-weight:bold; }
.chat-messages { padding:8px; max-height:300px; overflow-y:auto; }
.chat-message { padding:6px 10px; margin:4px 0; border-radius:12px; background:#f1f0f0; pointer-events:none; }
.chat-message.owner { background:gold; }
.chat-message .title { font-weight:bold; display:block; }
</style>
</head>
<body>

<main id="app" class="container">
<h1>üîê TOTP Web (Client-Side)</h1>

<section id="auth" class="card">
<p>Master-Passwort (wird nur lokal verwendet):</p>
<div class="row">
<input id="pw" type="password" placeholder="Master-Passwort">
<button id="unlock" class="primary">Entsperren / Neues Passwort</button>
<button id="import" class="muted">Import (verschl√ºsselte Datei)</button>
<input id="filein" type="file" style="display:none">
</div>
<p class="mutetxt">Wenn keine Daten vorhanden sind, legt Entsperren ein neues, leeres Vault an.</p>
</section>

<section id="main" class="card" style="display:none">
<div class="controls row">
<button id="add" class="primary">Neuen Account</button>
<button id="export" class="muted">Export (verschl√ºsselt)</button>
<button id="lock" class="danger">Sperren</button>
</div>
<div id="list" class="list"></div>
<p class="mutetxt">Die verschl√ºsselte Sicherungsdatei wird im Browser-Storage abgelegt. <strong>Teile niemals dein Master-Passwort.</strong></p>
</section>

</main>

<!-- Owner Control Button -->
<button id="ownerBtn" class="smallbtn" title="Owner Control">üõ°Ô∏è Owner</button>

<!-- Owner Control Panel -->
<aside id="ownerPanel">
  <header class="chat-header">
    <span>Besitzer-Kontrolle</span>
    <button id="closeOwner">‚úï</button>
  </header>

  <!-- PIN Setup -->
  <div id="ownerSetup">
    <input id="ownerPinNew" type="password" placeholder="Neuen PIN festlegen">
    <button id="ownerSetBtn" class="primary">PIN speichern</button>
  </div>

  <!-- PIN Login -->
  <div id="ownerLogin" style="display:none">
    <input id="ownerPinInput" type="password" placeholder="PIN eingeben">
    <button id="ownerUnlock" class="primary">Entsperren</button>
  </div>

  <!-- Owner Content -->
  <div id="ownerContent" style="display:none">
    <div id="ownerChat" class="chat-messages"></div>
    <button id="viewVault" class="primary">Vault anzeigen</button>
    <button id="resetVault" class="danger">Vault zur√ºcksetzen</button>
  </div>
</aside>

<script src="app.js"></script>
<script>
// --- Owner Panel Logik ---
const ownerBtn = document.getElementById('ownerBtn');
const ownerPanel = document.getElementById('ownerPanel');
const ownerSetup = document.getElementById('ownerSetup');
const ownerLogin = document.getElementById('ownerLogin');
const ownerContent = document.getElementById('ownerContent');
const ownerChat = document.getElementById('ownerChat');
const closeOwner = document.getElementById('closeOwner');

ownerBtn.addEventListener('click', ()=>{
    const storedPin = localStorage.getItem('ownerPIN');
    if(!storedPin) {
        ownerSetup.style.display='block';
        ownerLogin.style.display='none';
        ownerContent.style.display='none';
    } else {
        ownerSetup.style.display='none';
        ownerLogin.style.display='block';
        ownerContent.style.display='none';
    }
    ownerPanel.style.display='block';
});
closeOwner.addEventListener('click', ()=>{ ownerPanel.style.display='none'; });

// PIN Setup
document.getElementById('ownerSetBtn').addEventListener('click', ()=>{
    const pin = document.getElementById('ownerPinNew').value;
    if(!pin) { alert('PIN eingeben'); return; }
    localStorage.setItem('ownerPIN', pin);
    alert('PIN gespeichert!');
    ownerSetup.style.display='none';
    ownerLogin.style.display='block';
});

// PIN Login
document.getElementById('ownerUnlock').addEventListener('click', ()=>{
    const input = document.getElementById('ownerPinInput').value;
    const stored = localStorage.getItem('ownerPIN');
    if(input===stored){
        ownerLogin.style.display='none';
        ownerContent.style.display='block';
        renderOwnerVault();
    } else alert('Falscher PIN!');
});

// Vault im Owner Chat anzeigen
function renderOwnerVault(){
    ownerChat.innerHTML='';
    vault.forEach(async (acc)=>{
        const {otp, secondsLeft} = await totpFromBase32(acc.secret);
        const div = document.createElement('div');
        div.className='chat-message owner';
        div.innerHTML=`<span class="title">${acc.name}</span><span class="code">${otp}</span> <span class="muted">${secondsLeft}s</span>`;
        ownerChat.appendChild(div);
    });
    ownerChat.scrollTop = ownerChat.scrollHeight;
}

// Reset Vault
document.getElementById('resetVault').addEventListener('click', ()=>{
    if(confirm('Vault wirklich zur√ºcksetzen?')){ vault=[]; localStorage.removeItem('totp_vault'); renderOwnerVault(); }
});
</script>
</body>
</html>
